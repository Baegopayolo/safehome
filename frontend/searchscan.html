<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„¸ì´í”„í™ˆ - ì§€ì—­ ë§¤ë¬¼ ë¶„ì„ ê²€ìƒ‰</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% include '_navbar.html' %}
    <main>
        <h2 style="text-align: center; margin-top: 20px;">ì§€ì—­ ë§¤ë¬¼ ë¶„ì„ ê²€ìƒ‰</h2>
        <hr style="margin-bottom: 20px;">

        <div id="search-bar">
            <span class="search-input-wrap">
                <input type="text" id="region-input" placeholder="ë¶„ì„í•  ë™ ì´ë¦„(ì˜ˆ: í™”ê³¡ë™)ì„ ì…ë ¥í•˜ì„¸ìš”">
                <button type="button" class="clear-btn-in" id="clear-btn-in" title="ì§€ìš°ê¸°">&#10006;</button>
            </span>
            <button id="search-btn" class="btn btn-search" onclick="searchRegion()">ê²€ìƒ‰</button>
        </div>
        <div id="search-result"></div>
    </main>
    <script>
function searchRegion() {
    const region = document.getElementById('region-input').value.trim();
    const resultDiv = document.getElementById('search-result');
    if (!region) {
        resultDiv.innerHTML = '<p style="color:#d9534f">ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</p>';
        return;
    }

    // ë¡œë”© ìƒíƒœ
    resultDiv.innerHTML = `
        <div class="loading">
            <span class="spinner"></span>
            <span>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>
        </div>
    `;

    fetch(`http://127.0.0.1:5000/analyze?region=${encodeURIComponent(region)}`)
        .then(res => res.json())
        .then(data => {
            const props = Array.isArray(data.properties) ? data.properties : [];
            if (props.length === 0) {
                resultDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-emoji">ğŸ”</div>
                        <p>í•´ë‹¹ ì§€ì—­ì˜ ë§¤ë¬¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <small>ì§€ì—­ëª…ì„ ë‹¤ì‹œ í™•ì¸í•˜ê±°ë‚˜ ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.</small>
                    </div>
                `;
                return;
            }
            renderResults(region, props, resultDiv);
        })
        .catch(() => {
            resultDiv.innerHTML = `<p style='color:#d9534f'>ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
        });
}

function renderResults(region, props, container) {
    let properties = [...props];

    const headerHTML = (count) => `
        <div class="result-head">
            <h2>"${region}" ë§¤ë¬¼ ë¶„ì„ ê²°ê³¼ <span class="badge badge-neutral" id="result-count">${count}</span></h2>
            <div class="controls">
                <label for="sort-select">ì •ë ¬</label>
                <select id="sort-select" class="ctrl">
                    <option value="default">ê¸°ë³¸ìˆœ</option>
                    <option value="warnDesc">ìœ„í—˜ìš”ì†Œ ë§ìŒìˆœ</option>
                    <option value="warnAsc">ìœ„í—˜ìš”ì†Œ ì ìŒìˆœ</option>
                </select>
                <label for="filter-input">í•„í„°</label>
                <input id="filter-input" class="ctrl" placeholder="ê²½ê³  í‚¤ì›Œë“œ ë˜ëŠ” ë§¤ë¬¼ëª…">
                <button id="expand-all" class="link-btn">ì „ì²´ í¼ì¹˜ê¸°</button>
                <button id="collapse-all" class="link-btn">ì „ì²´ ì ‘ê¸°</button>
            </div>
        </div>
    `;

    const buildCards = (list) => list.map((prop, idx) => {
        const name = prop.name || `ë§¤ë¬¼ #${idx+1}`;
        const warns = Array.isArray(prop.warnings) ? prop.warnings : [];
        const checklist = Array.isArray(prop.checklist) ? prop.checklist : [];
        const warnCount = warns.length;

        const risk =
            warnCount >= 5 ? 'high' :
            warnCount >= 2 ? 'med' : 'low';

        const warnItems = warns.length
            ? warns.map(w => `<li>âš ï¸ ${w}</li>`).join('')
            : `<li>âœ… íŠ¹ì´ì‚¬í•­ ì—†ìŒ</li>`;

        const checklistItems = checklist.length
            ? checklist.map(c => `<li>â˜‘ ${c}</li>`).join('')
            : `<li>ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;

        return `
            <div class="property-item" data-warnings="${warns.join(' ').toLowerCase()}" data-name="${(name||'').toLowerCase()}">
                <div class="card-head">
                    <h3>${name}</h3>
                    <span class="badge ${risk === 'high' ? 'badge-danger' : risk === 'med' ? 'badge-warn' : 'badge-success'}">
                        ê²½ê³  ${warnCount}
                    </span>
                </div>
                <div class="warnings">
                    <ul class="warn-list">${warnItems}</ul>
                </div>
                <h4 class="check-toggle">[ì•ˆì „ ê³„ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸] â–¾</h4>
                <ul class="checklist collapsed">
                    ${checklistItems}
                </ul>
            </div>
        `;
    }).join('');

    container.innerHTML = `
        ${headerHTML(properties.length)}
        <div class="property-list">
            ${buildCards(properties)}
        </div>
    `;

    const applyFilterAndSort = () => {
        const sortVal = document.getElementById('sort-select').value;
        const q = document.getElementById('filter-input').value.trim().toLowerCase();

        let list = [...properties];

        // ì •ë ¬
        if (sortVal === 'warnDesc') {
            list.sort((a, b) => (b.warnings?.length || 0) - (a.warnings?.length || 0));
        } else if (sortVal === 'warnAsc') {
            list.sort((a, b) => (a.warnings?.length || 0) - (b.warnings?.length || 0));
        }

        // í•„í„°
        if (q) {
            list = list.filter(p =>
                (p.warnings || []).join(' ').toLowerCase().includes(q) ||
                (p.name || '').toLowerCase().includes(q)
            );
        }

        document.querySelector('.property-list').innerHTML = buildCards(list);
        attachCardHandlers();
        document.getElementById('result-count').textContent = list.length;
    };

    const attachCardHandlers = () => {
        document.querySelectorAll('.check-toggle').forEach(h => {
            h.addEventListener('click', () => {
                let next = h.nextElementSibling;
                if (!next || !next.classList || !next.classList.contains('checklist')) {
                    const container = h.closest('.property-item');
                    next = container ? container.querySelector('.checklist') : null;
                }
                if (!next) return;
                next.classList.toggle('collapsed');
                h.textContent = next.classList.contains('collapsed') ? '[ì•ˆì „ ê³„ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸] â–¾' : '[ì•ˆì „ ê³„ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸] â–´';
            });
        });
    };

    // ì´ˆê¸° í•¸ë“¤ëŸ¬
    attachCardHandlers();

    // ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
    document.getElementById('sort-select').addEventListener('change', applyFilterAndSort);
    document.getElementById('filter-input').addEventListener('input', applyFilterAndSort);

    document.getElementById('expand-all').addEventListener('click', () => {
        document.querySelectorAll('.property-item').forEach(item => {
            const list = item.querySelector('.checklist');
            const toggle = item.querySelector('.check-toggle');
            if (list && list.classList.contains('collapsed')) {
                list.classList.remove('collapsed');
                if (toggle) toggle.textContent = '[ì•ˆì „ ê³„ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸] â–´';
            }
        });
    });
    document.getElementById('collapse-all').addEventListener('click', () => {
        document.querySelectorAll('.property-item').forEach(item => {
            const list = item.querySelector('.checklist');
            const toggle = item.querySelector('.check-toggle');
            if (list && !list.classList.contains('collapsed')) {
                list.classList.add('collapsed');
                if (toggle) toggle.textContent = '[ì•ˆì „ ê³„ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸] â–¾';
            }
        });
    });
}

// xë²„íŠ¼ í´ë¦­ ì‹œ input ì´ˆê¸°í™”
document.getElementById('clear-btn-in').onclick = function() {
    const input = document.getElementById('region-input');
    input.value = '';
    input.focus();
};
// ì—”í„°í‚¤ë¡œë„ ê²€ìƒ‰ ê°€ëŠ¥
document.getElementById('region-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') searchRegion();
});
</script>
</body>
</html>
