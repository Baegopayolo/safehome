<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„¸ì´í”„í™ˆ - ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mypage.css') }}">
</head>
<body>
    {% include '_navbar.html' %}
    
    <div class="container">
        <div class="page-header">
            <h1>ë§ˆì´í˜ì´ì§€</h1>
            <p class="welcome-text">ğŸ‘‹ {{ username }}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {{ category }}">
                    <span>{% if category == 'success' %}âœ“{% elif category == 'danger' %}âš ï¸{% elif category == 'warning' %}âš ï¸{% else %}â„¹ï¸{% endif %}</span>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- ì‚¬ìš©ì ì •ë³´ ì¹´ë“œ -->
        <div class="user-info-card">
            <div class="user-avatar">
                ğŸ‘¤
            </div>
            <div class="user-details">
                <div class="user-name">{{ username }}</div>
                <div class="user-meta">
                    <div class="user-meta-item">
                        ğŸ“… ê°€ì…ì¼: {{ join_date }}
                    </div>
                    <div class="user-meta-item">
                        âœ“ ë¡œê·¸ì¸ ìƒíƒœ
                    </div>
                </div>
                <div class="user-stats">
                    <div class="user-stat">
                        <div class="user-stat-value" data-count="{{ favorites|length }}">0</div>
                        <div class="user-stat-label">ì¦ê²¨ì°¾ê¸°</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value" data-count="{{ reviews|length }}" id="review-count">0</div>
                        <div class="user-stat-label">ë‚´ ë¦¬ë·°</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value" data-count="{{ notifications|length }}">0</div>
                        <div class="user-stat-label">ì•Œë¦¼</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value" data-count="{{ reports|length }}" id="report-count">0</div>
                        <div class="user-stat-label">ì‹ ê³ </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¦ê²¨ì°¾ê¸° -->
        <div class="card">
            <div class="card-header">
                <h3><span class="card-icon">â­</span> ì¦ê²¨ì°¾ê¸°</h3>
                <a href="#" class="view-all-link">ì „ì²´ë³´ê¸° â†’</a>
            </div>
            
            <!-- ìœ„í—˜ë„ ë²”ë¡€ -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 12px;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 3px;"></div>
                    <span>ìœ„í—˜ (80ì  ì´ìƒ)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #ffc107; border-radius: 3px;"></div>
                    <span>ì£¼ì˜ (60-79ì )</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #28a745; border-radius: 3px;"></div>
                    <span>ì•ˆì „ (60ì  ë¯¸ë§Œ)</span>
                </div>
            </div>
            
            {% if favorites %}
            <div class="favorite-list">
                {% for fav in favorites %}
                <div class="favorite-item">
                    <div class="item-content">
                        <div class="item-title">
                            {{ fav.address }}
                            {% if fav.risk_level == 'safe' %}
                            <span class="risk-badge safe">ì•ˆì „</span>
                            {% elif fav.risk_level == 'warning' %}
                            <span class="risk-badge warning">ì£¼ì˜</span>
                            {% else %}
                            <span class="risk-badge danger">ìœ„í—˜</span>
                            {% endif %}
                        </div>
                        <div class="item-meta">{{ fav.date_added }} Â· ìœ„í—˜ë„: {{ fav.risk_score }}ì </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-small btn-view" onclick="searchFromFavorite('{{ fav.address }}')">ê²€ìƒ‰</button>
                        <button class="btn-small btn-view" onclick="window.location.href='/map?region={{ fav.address }}'">ì§€ë„ë³´ê¸°</button>
                        <button class="btn-small btn-remove" onclick="removeFavorite('{{ fav.id }}')">ì‚­ì œ</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p>ì¦ê²¨ì°¾ê¸°í•œ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê´€ì‹¬ ìˆëŠ” ì§€ì—­ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            </div>
            {% endif %}
        </div>

        <!-- ë‚´ ë¦¬ë·° -->
        <div class="card">
            <div class="card-header">
                <h3><span class="card-icon">â­</span> ë‚´ ë¦¬ë·°</h3>
                <a href="#" class="view-all-link" onclick="openReviewModal(); return false;">ë¦¬ë·° ì‘ì„±í•˜ê¸° â†’</a>
            </div>
            
            {% if reviews %}
            <div class="history-list">
                {% for review in reviews %}
                <div class="history-item" data-review-id="{{ review.id }}" data-review-region="{{ review.region }}" data-review-rating="{{ review.rating }}" data-review-content="{{ review.content }}">
                    <div class="item-content">
                        <div class="item-title">
                            {{ review.region }}
                            <div style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;">
                                {% if review.rating %}
                                    {% for i in range(5) %}
                                        {% if i < review.rating %}
                                            <span style="color: #ffc107; font-size: 14px;">â˜…</span>
                                        {% else %}
                                            <span style="color: #ddd; font-size: 14px;">â˜†</span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span style="color: #ddd; font-size: 14px;">â˜†â˜†â˜†â˜†â˜†</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="item-meta">
                            {{ review.content or 'ë‚´ìš© ì—†ìŒ' }}
                        </div>
                        <div class="item-meta" style="font-size: 12px; color: #9ca3af; margin-top: 4px;">{{ review.created_at }}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-small btn-edit" onclick="editReview({{ review.id }}, '{{ review.region }}', {{ review.rating or 0 }}, '{{ review.content|replace("'", "\\'")|replace('"', '\\"') }}')" title="ìˆ˜ì •">âœï¸</button>
                        <button class="btn-small btn-danger" onclick="deleteReview({{ review.id }})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">â­</div>
                <p>ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <button class="btn" onclick="openReviewModal()" style="margin-top: 16px; background: #1565c0; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">ë¦¬ë·° ì‘ì„±í•˜ê¸°</button>
            </div>
            {% endif %}
        </div>

        <!-- ì•Œë¦¼ -->
        <div class="card">
            <div class="card-header">
                <h3><span class="card-icon">ğŸ””</span> ì•Œë¦¼</h3>
                <a href="#" class="view-all-link" onclick="markAllNotificationsAsRead(); return false;">ëª¨ë‘ ì½ìŒìœ¼ë¡œ í‘œì‹œ â†’</a>
            </div>
            
            {% if notifications %}
            <div class="notification-list" id="notification-list">
                {% for notif in notifications[:5] %}
                <div class="notification-item {% if not notif.is_read %}unread{% endif %} {{ notif.type or 'info' }}" onclick="readNotification('{{ notif.id }}')">
                    {% if not notif.is_read %}<div class="notification-dot"></div>{% endif %}
                    <div class="item-content">
                        <div class="item-title">{{ notif.title }}</div>
                        <div class="item-meta">{{ notif.message }}</div>
                        <div class="item-meta" style="font-size: 12px; color: #9ca3af; margin-top: 4px;">{{ notif.created_at }}</div>
                    </div>
                </div>
                {% endfor %}
                {% if notifications|length > 5 %}
                <div id="hidden-notifications" style="display: none;">
                    {% for notif in notifications[5:] %}
                    <div class="notification-item {% if not notif.is_read %}unread{% endif %} {{ notif.type or 'info' }}" onclick="readNotification('{{ notif.id }}')">
                        {% if not notif.is_read %}<div class="notification-dot"></div>{% endif %}
                        <div class="item-content">
                            <div class="item-title">{{ notif.title }}</div>
                            <div class="item-meta">{{ notif.message }}</div>
                            <div class="item-meta" style="font-size: 12px; color: #9ca3af; margin-top: 4px;">{{ notif.created_at }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button id="show-more-notifications" class="btn-small btn-view" onclick="showMoreNotifications()">ë”ë³´ê¸° ({{ notifications|length - 5 }}ê°œ)</button>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”•</div>
                <p>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            {% endif %}
        </div>

        <!-- ì‹ ê³  ë‚´ì—­ -->
        <div class="card">
            <div class="card-header">
                <h3><span class="card-icon">ğŸš¨</span> ë‚´ ì‹ ê³  ë‚´ì—­</h3>
                <span class="view-all-link">{{ reports|length }}ê±´</span>
            </div>
            
            {% if reports %}
            <div class="history-list">
                {% for report in reports %}
                <div class="history-item">
                    <div class="item-content">
                        <div class="item-title">
                            <strong>{{ report.region }}</strong>
                            {% if report.status == 'pending' %}
                            <span class="risk-badge warning">ëŒ€ê¸°ì¤‘</span>
                            {% elif report.status == 'investigating' %}
                            <span class="risk-badge warning">ì¡°ì‚¬ì¤‘</span>
                            {% elif report.status == 'resolved' %}
                            <span class="risk-badge safe">ì²˜ë¦¬ì™„ë£Œ</span>
                            {% else %}
                            <span class="risk-badge warning">ëŒ€ê¸°ì¤‘</span>
                            {% endif %}
                        </div>
                        <div class="item-meta" style="margin-top: 8px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: #dc3545;">{{ report.report_type_kr }}</span>
                                <span style="color: #6c757d;">Â·</span>
                                <span style="color: #6c757d; font-size: 13px;">{{ report.created_at }}</span>
                            </div>
                            {% if report.property_address and report.property_address != 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ' %}
                            <div style="font-size: 13px; color: #495057; margin-top: 4px;">
                                ğŸ“ {{ report.property_address }}
                            </div>
                            {% endif %}
                            {% if report.description %}
                            <div style="font-size: 12px; color: #6c757d; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; line-height: 1.5;">
                                {{ report.description }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <p>ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë§¤ë¬¼ì„ ë°œê²¬í•˜ì‹œë©´ ì‹ ê³ í•´ì£¼ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>

        <!-- ë‚´ ì •ë³´ -->
        <div class="card">
            <div class="card-header">
                <h3><span class="card-icon">ğŸ‘¤</span> ë‚´ ì •ë³´</h3>
            </div>
            <div class="row">
                <div class="form-group">
                    <label>ì•„ì´ë””</label>
                    <input type="text" value="{{ username }}" readonly style="background: #f9fafb; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>ê°€ì…ì¼</label>
                    <input type="text" value="{{ join_date }}" readonly style="background: #f9fafb; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>ë¡œê·¸ì¸ ìƒíƒœ</label>
                    <input type="text" value="ë¡œê·¸ì¸ë¨ âœ“" readonly style="background: #f9fafb; cursor: not-allowed;">
                </div>
            </div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="card">
            <div class="card-header">
                <h3><span class="card-icon">ğŸ”</span> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            </div>
            <form method="POST" action="{{ url_for('change_password') }}">
                <div class="row">
                    <div class="form-group">
                        <label for="current_password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="current_password" name="current_password" required placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label for="new_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="new_password" name="new_password" minlength="6" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="confirm_password" name="confirm_password" minlength="6" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button type="submit" class="btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="background: white; color: #1565c0; border: 2px solid #1565c0; text-decoration: none; display: inline-block; text-align: center;">ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ -->
    <div id="review-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;" id="modal-title">ë¦¬ë·° ì‘ì„±</h3>
                <button onclick="closeReviewModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>
            <form id="review-form">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì§€ì—­ëª…</label>
                    <input type="text" id="review-region" placeholder="ì˜ˆ: ê°•ë‚¨êµ¬ ì—­ì‚¼ë™" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">í‰ì </label>
                    <div class="rating-stars" id="rating-stars" style="display: flex; gap: 8px; font-size: 32px;">
                        <span class="star" data-rating="1" style="cursor: pointer; color: #ddd;">â˜…</span>
                        <span class="star" data-rating="2" style="cursor: pointer; color: #ddd;">â˜…</span>
                        <span class="star" data-rating="3" style="cursor: pointer; color: #ddd;">â˜…</span>
                        <span class="star" data-rating="4" style="cursor: pointer; color: #ddd;">â˜…</span>
                        <span class="star" data-rating="5" style="cursor: pointer; color: #ddd;">â˜…</span>
                    </div>
                    <input type="hidden" id="review-rating" value="0" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ë¦¬ë·° ë‚´ìš©</label>
                    <textarea id="review-content" placeholder="ì´ ì§€ì—­ì— ëŒ€í•œ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; min-height: 120px; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeReviewModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
                    <button type="submit" style="padding: 10px 20px; background: #1565c0; color: white; border: none; border-radius: 6px; cursor: pointer;">ë¦¬ë·° ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/mypage.js') }}"></script>
    {% include '_footer.html' %}
</body>
</html>
