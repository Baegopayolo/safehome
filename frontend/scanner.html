<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>세이프홈 - 스캐너 결과</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% include '_navbar.html' %}
    <main>
        <h1 id="region-title">분석 결과 로딩 중...</h1>
        <hr>
        <div id="property-list"></div>
    </main>

    <script>
        // 이 스크립트는 페이지가 로드되자마자 실행됩니다.
        window.onload = function() {
            // 1. 현재 웹페이지 주소에서 'region' 파라미터 값을 가져옵니다.
            // 예: scanner.html?region=화곡동  -> '화곡동'을 가져옴
            const urlParams = new URLSearchParams(window.location.search);
            const regionName = urlParams.get('region');

            if (regionName) {
                document.getElementById('region-title').innerText = `${regionName} 매물 분석 결과`;

                // 2. 가져온 지역 이름으로 백엔드에 분석 데이터를 요청합니다.
                fetch(`http://127.0.0.1:5000/analyze?region=${regionName}`)
                    .then(response => response.json()) // 응답을 JSON 형태로 변환
                    .then(data => {
                        const propertyListDiv = document.getElementById('property-list');
                        propertyListDiv.innerHTML = ''; // 기본 메시지 지우기

                        // 3. 받은 데이터(매물 목록)를 하나씩 화면에 그려줍니다.
                        data.property.forEach(prop => {
                            let html = `
                                <div class="-item">
                                    <h3>${prop.name}</h3>
                                    <p class="warnings">${prop.warnings.join('<br>')}</p>
                                    <h4 class="check-toggle">[안전 계약 체크리스트] ▾</h4>
                                <ul class="checklist collapsed">
                                    <li>
            <strong>등기부등본 확인:</strong> 선순위 대출(근저당)이 과도하지 않은지 확인합니다.
            (<a href="guide-docs.html">자세히 보는 법</a>)
        </li>
        <li>
            <strong>HUG 보증보험 가입:</strong> 가입 가능한 매물인지 최우선으로 확인합니다.
            (<a href="guide-hug.html">가입 조건 보기</a>)
        </li>
        <li>
            <strong>세금 완납증명서 확인:</strong> 계약 시 임대인의 '국세/지방세 완납증명서'를 반드시 요구하여 세금 체납이 없는지 확인합니다.
        </li>
        <li>
            <strong>소유주 신원 확인:</strong> 계약 당일, 임대인의 신분증과 등기부등본상 소유주 정보가 일치하는지 반드시 대조합니다.
        </li>
        <li>
            <strong>전입신고 및 확정일자:</strong> 잔금을 치른 즉시 주민센터에 방문하거나 온라인으로 전입신고와 확정일자를 받아야 법적 보호(대항력)가 생깁니다.
        </li>
    </ul>`;
                            html += `</div>`;
                            propertyListDiv.innerHTML += html;
                        });
                        // toggle listeners for checklists
                        document.querySelectorAll('.check-toggle').forEach(h => {
                            h.addEventListener('click', () => {
                                let next = h.nextElementSibling;
                                if (!next || !next.classList || !next.classList.contains('checklist')) {
                                    const container = h.closest('.-item') || h.closest('.property-item');
                                    next = container ? container.querySelector('.checklist') : null;
                                }
                                if (!next) return;
                                next.classList.toggle('collapsed');
                                h.textContent = next.classList.contains('collapsed') ? '[안전 계약 체크리스트] ▾' : '[안전 계약 체크리스트] ▴';
                            });
                        });
                    })
                    .catch(error => {
                        document.getElementById('property-list').innerText = '데이터를 불러오는 데 실패했습니다. 백엔드 서버가 켜져 있는지 확인해주세요.';
                        console.error('Error:', error);
                    });
            } else {
                document.getElementById('region-title').innerText = '분석할 지역 정보가 없습니다.';
            }
        };
    </script>
</body>
</html>